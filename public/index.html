<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>briefe-einfach</title>
  <style>
    :root{
      --bg: #0b1020;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.08);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.65);
      --border: rgba(255,255,255,.12);
      --btn: rgba(255,255,255,.12);
      --btn2: rgba(255,255,255,.18);
      --danger: rgba(255,90,90,.18);
      --ok: rgba(80,220,140,.18);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(84,178,255,.18), transparent 60%),
        radial-gradient(800px 500px at 90% 10%, rgba(255,80,200,.14), transparent 55%),
        radial-gradient(900px 600px at 30% 90%, rgba(100,255,180,.10), transparent 55%),
        var(--bg);
      color: var(--text);
      min-height: 100vh;
    }
    .wrap{max-width:1100px;margin:28px auto;padding:0 18px}
    header{
      display:flex;align-items:center;justify-content:space-between;gap:12px;
      padding:14px 16px;border:1px solid var(--border);border-radius:16px;
      background: rgba(0,0,0,.22);
      backdrop-filter: blur(10px);
    }
    .brand{display:flex;align-items:center;gap:10px}
    .logo{
      width:34px;height:34px;border-radius:10px;
      background: linear-gradient(135deg, rgba(84,178,255,.9), rgba(255,80,200,.85));
      display:grid;place-items:center;font-weight:700;color:#061225;
    }
    .title{line-height:1.1}
    .title b{display:block;font-size:16px}
    .title span{display:block;font-size:12px;color:var(--muted);margin-top:3px}
    .right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
    .pill{
      padding:6px 10px;border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      border-radius:999px;font-size:12px;color:var(--muted);
    }
    .btn{
      border:1px solid var(--border);
      background: var(--btn);
      color: var(--text);
      padding:9px 12px;border-radius:12px;
      cursor:pointer;
      transition:.15s;
      font-weight:600;
    }
    .btn:hover{background: var(--btn2)}
    .btn.primary{background: rgba(84,178,255,.18)}
    .btn.danger{background: rgba(255,90,90,.14)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    main{
      margin-top:16px;
      display:grid;
      grid-template-columns: 2fr 1fr;
      gap:16px;
    }
    @media (max-width: 920px){
      main{grid-template-columns:1fr}
    }
    .card{
      border:1px solid var(--border);
      background: rgba(0,0,0,.22);
      backdrop-filter: blur(10px);
      border-radius:16px;
      padding:14px;
    }
    .card h3{
      margin:0 0 8px;font-size:14px;
      display:flex;align-items:center;gap:8px;
    }
    .muted{color:var(--muted);font-size:12px}
    textarea{
      width:100%;
      min-height:160px;
      resize:vertical;
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:12px;border-radius:14px;
      outline:none;
    }
    input, select{
      width:100%;
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:10px 12px;border-radius:12px;
      outline:none;
    }
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex:1}
    .actions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .out{
      margin-top:12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      border-radius:14px;
      padding:12px;
    }
    .out pre{
      margin:0;
      white-space:pre-wrap;
      word-break:break-word;
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;
      font-size:12px;
      color: rgba(255,255,255,.88);
    }
    .status{
      display:flex;gap:8px;flex-wrap:wrap;align-items:center;
      margin-top:10px;
    }
    .tag{
      padding:6px 10px;border-radius:999px;
      border:1px solid var(--border);
      font-size:12px;
      background: rgba(255,255,255,.06);
      color: var(--muted);
    }
    .tag.ok{background: var(--ok); color: rgba(210,255,230,.95)}
    .tag.bad{background: var(--danger); color: rgba(255,220,220,.95)}
    /* Modal */
    .modalBackdrop{
      position:fixed;inset:0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index: 10;
    }
    .modal{
      width:min(520px, 100%);
      border:1px solid var(--border);
      background: rgba(10,14,30,.92);
      border-radius:16px;
      padding:14px;
      box-shadow: 0 10px 40px rgba(0,0,0,.45);
    }
    .modal h3{margin:0 0 10px}
    .modal .actions{justify-content:flex-end}
    .linkish{color: rgba(84,178,255,.92); cursor:pointer; font-weight:700}
    .sep{height:1px;background:var(--border);margin:10px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">B</div>
        <div class="title">
          <b>briefe-einfach</b>
          <span>Text rein ‚Üí Erkl√§rung + Fristenhilfe (MVP)</span>
        </div>
      </div>

      <div class="right">
        <div id="userPill" class="pill">nicht eingeloggt</div>
        <button id="btnAuth" class="btn primary">Login / Registrieren</button>
        <button id="btnLogout" class="btn danger" style="display:none">Logout</button>
      </div>
    </header>

    <main>
      <!-- LEFT -->
      <section class="card">
        <h3>üìÑ Originaltext</h3>
        <div class="muted">F√ºge einen Brief/Beh√∂rden-Text ein ‚Üí klicke <b>Erkl√§ren</b>. (Strg+Enter geht auch)</div>
        <div style="margin-top:10px">
          <textarea id="txtInput" placeholder="Text hier einf√ºgen..."></textarea>
        </div>

        <div class="actions">
          <button id="btnExplain" class="btn primary">Erkl√§ren</button>
          <button id="btnClear" class="btn">Leeren</button>
          <button id="btnCopy" class="btn" disabled>Ergebnis kopieren</button>
          <button id="btnSubscribe" class="btn primary">Abo starten (6,99‚Ç¨/Monat)</button>
        </div>

        <div class="status">
          <span class="tag" id="tagLogin">Login: unbekannt</span>
          <span class="tag" id="tagPro">Pro: unbekannt</span>
        </div>

        <div class="out">
          <div class="muted" style="margin-bottom:6px">Ergebnis</div>
          <pre id="outText">Noch kein Ergebnis.</pre>
        </div>
      </section>

      <!-- RIGHT -->
      <aside class="card">
        <h3>‚è≥ Fristenrechner (MVP)</h3>
        <div class="muted">MVP: ohne Feiertage/Sonderregeln.</div>
        <div class="sep"></div>

        <label class="muted">Eingangsdatum (Start)</label>
        <input id="dateStart" placeholder="tt.mm.jjjj" />

        <div style="height:10px"></div>

        <label class="muted">Frist in Tagen</label>
        <input id="days" type="number" value="14" min="1" />

        <div style="height:10px"></div>

        <label class="muted">Z√§hlweise</label>
        <select id="mode">
          <option value="nextday" selected>Start am n√§chsten Tag</option>
          <option value="same">Start am selben Tag</option>
        </select>

        <div class="actions" style="margin-top:12px">
          <button id="btnCalc" class="btn primary">Frist berechnen</button>
          <button id="btnToday" class="btn">Heute einsetzen</button>
        </div>

        <div class="out">
          <div class="muted" style="margin-bottom:6px">Ergebnis</div>
          <pre id="outDeadline">Noch nichts berechnet.</pre>
        </div>
      </aside>
    </main>
  </div>

  <!-- AUTH MODAL -->
  <div id="authBackdrop" class="modalBackdrop">
    <div class="modal">
      <h3 id="authTitle">Registrieren</h3>

      <label class="muted">E-Mail</label>
      <input id="authEmail" autocomplete="email" />

      <div style="height:10px"></div>

      <label class="muted">Passwort</label>
      <input id="authPass" type="password" autocomplete="current-password" />

      <div style="height:10px"></div>

      <div id="authError" class="tag bad" style="display:none">Fehler</div>

      <div class="actions">
        <button id="btnAuthSubmit" class="btn primary">Registrieren</button>
        <button id="btnAuthClose" class="btn">Schlie√üen</button>
      </div>

      <div class="muted" style="margin-top:8px">
        Schon ein Konto? <span id="toggleAuth" class="linkish">Login</span>
      </div>
    </div>
  </div>

  <script>
    // ========= Helpers =========
    const $ = (id) => document.getElementById(id);
    const setText = (el, text) => { el.textContent = text; };
    const show = (el) => el.style.display = "";
    const hide = (el) => el.style.display = "none";

    function formatDate(d){
      const dd = String(d.getDate()).padStart(2,"0");
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const yy = d.getFullYear();
      return `${dd}.${mm}.${yy}`;
    }
    function parseGermanDate(s){
      const m = (s||"").trim().match(/^(\d{2})\.(\d{2})\.(\d{4})$/);
      if(!m) return null;
      const dd = +m[1], mm = +m[2], yy = +m[3];
      const d = new Date(yy, mm-1, dd);
      if(d.getFullYear()!==yy || d.getMonth()!==mm-1 || d.getDate()!==dd) return null;
      return d;
    }

    // ========= API calls (IMPORTANT: credentials include) =========
    async function apiPost(url, body){
      const r = await fetch(url, {
        method: "POST",
        headers: body ? {"Content-Type":"application/json"} : undefined,
        credentials: "include",
        body: body ? JSON.stringify(body) : undefined
      });
      const ct = r.headers.get("content-type") || "";
      const data = ct.includes("application/json") ? await r.json() : await r.text();
      if(!r.ok){
        const msg = (data && data.error) ? data.error : (typeof data === "string" ? data : "Request fehlgeschlagen");
        throw new Error(msg);
      }
      return data;
    }

    async function apiGet(url){
      const r = await fetch(url, { credentials: "include" });
      const ct = r.headers.get("content-type") || "";
      const data = ct.includes("application/json") ? await r.json() : await r.text();
      if(!r.ok){
        const msg = (data && data.error) ? data.error : (typeof data === "string" ? data : "Request fehlgeschlagen");
        throw new Error(msg);
      }
      return data;
    }

    // ========= Auth UI =========
    let authMode = "register"; // "login" | "register"

    function openAuth(mode){
      authMode = mode || "register";
      $("authBackdrop").style.display = "flex";
      $("authError").style.display = "none";
      if(authMode === "login"){
        setText($("authTitle"), "Login");
        setText($("btnAuthSubmit"), "Login");
        setText($("toggleAuth"), "Registrieren");
      }else{
        setText($("authTitle"), "Registrieren");
        setText($("btnAuthSubmit"), "Registrieren");
        setText($("toggleAuth"), "Login");
      }
    }
    function closeAuth(){
      $("authBackdrop").style.display = "none";
    }
    function showAuthError(msg){
      setText($("authError"), msg || "Fehler");
      $("authError").style.display = "";
    }

    async function refreshMe(){
      // Backend sollte /auth/me liefern. Wenn nicht vorhanden, f√§llt es auf "not logged in".
      try{
        const me = await apiGet("/auth/me");
        // Erwartet: { ok:true, user:{email}, pro:true/false }
        const email = me?.user?.email || "eingeloggt";
        $("userPill").textContent = email;
        hide($("btnAuth"));
        show($("btnLogout"));

        $("tagLogin").className = "tag ok";
        $("tagLogin").textContent = "Login: ja";

        const pro = !!me?.pro;
        $("tagPro").className = pro ? "tag ok" : "tag";
        $("tagPro").textContent = "Pro: " + (pro ? "ja" : "nein");
        return { loggedIn:true, pro };
      }catch(e){
        $("userPill").textContent = "nicht eingeloggt";
        show($("btnAuth"));
        hide($("btnLogout"));

        $("tagLogin").className = "tag bad";
        $("tagLogin").textContent = "Login: nein";

        $("tagPro").className = "tag";
        $("tagPro").textContent = "Pro: unbekannt";
        return { loggedIn:false, pro:false };
      }
    }

    // ========= Features =========
    async function doExplain(){
      const text = $("txtInput").value.trim();
      if(!text){
        alert("Bitte Text einf√ºgen.");
        return;
      }
      // Dein Backend-Endpunkt kann anders hei√üen. H√§ufig: /api/explain
      // Wenn du einen anderen Pfad hast, sag mir kurz den Namen (oder ich passe es im server.js an).
      try{
        setText($("outText"), "‚Ä¶ arbeitet ‚Ä¶");
        $("btnCopy").disabled = true;

        const data = await apiPost("/api/explain", { text });
        // Erwartet z.B.: { short:"...", long:"...", todo:"..." }
        const out =
`Kurz erkl√§rt:
${data?.short ?? "-"}

Ausf√ºhrlich:
${data?.long ?? "-"}

Was du tun solltest:
${data?.todo ?? "-"}
`;
        setText($("outText"), out);
        $("btnCopy").disabled = false;
      }catch(e){
        setText($("outText"), "Fehler: " + e.message);
      }
    }

    function doCopy(){
      const t = $("outText").textContent || "";
      navigator.clipboard.writeText(t).then(()=>{
        alert("Kopiert ‚úÖ");
      }).catch(()=>{
        alert("Kopieren nicht m√∂glich ‚Äì bitte manuell markieren.");
      });
    }

    function doClear(){
      $("txtInput").value = "";
      setText($("outText"), "Noch kein Ergebnis.");
      $("btnCopy").disabled = true;
    }

    function calcDeadline(){
      const d = parseGermanDate($("dateStart").value);
      if(!d){ setText($("outDeadline"), "Bitte Datum im Format tt.mm.jjjj eingeben."); return; }
      const days = Math.max(1, parseInt($("days").value || "14", 10));
      const mode = $("mode").value;

      const start = new Date(d);
      if(mode === "nextday") start.setDate(start.getDate() + 1);

      const end = new Date(start);
      end.setDate(end.getDate() + (days - 1));

      setText($("outDeadline"),
`Start: ${formatDate(start)}
Tage: ${days}
Ende (MVP): ${formatDate(end)}
Hinweis: Feiertage/Wochenenden nicht ber√ºcksichtigt.`);
    }

    function setToday(){
      const d = new Date();
      $("dateStart").value = formatDate(d);
    }

    // ========= Billing =========
    async function startCheckout(){
      const me = await refreshMe();
      if(!me.loggedIn){
        alert("Not logged in");
        openAuth("login");
        return;
      }
      try{
        // Backend-Endpunkt: /billing/create-checkout-session
        const data = await apiPost("/billing/create-checkout-session");
        if(data?.url){
          window.location.href = data.url;
        }else{
          alert(data?.error || "Checkout Fehler: keine URL");
        }
      }catch(e){
        alert("Checkout Fehler: " + e.message);
      }
    }

    // ========= Wire up =========
    $("btnAuth").addEventListener("click", ()=> openAuth("register"));
    $("btnAuthClose").addEventListener("click", closeAuth);
    $("authBackdrop").addEventListener("click", (e)=>{ if(e.target.id==="authBackdrop") closeAuth(); });

    $("toggleAuth").addEventListener("click", ()=>{
      openAuth(authMode === "login" ? "register" : "login");
    });

    $("btnAuthSubmit").addEventListener("click", async ()=>{
      const email = $("authEmail").value.trim();
      const password = $("authPass").value;
      if(!email || !password) { showAuthError("Bitte E-Mail & Passwort eingeben."); return; }

      try{
        $("authError").style.display = "none";
        if(authMode === "login"){
          await apiPost("/auth/login", { email, password });
        }else{
          await apiPost("/auth/register", { email, password });
        }
        closeAuth();
        await refreshMe();
      }catch(e){
        showAuthError(e.message);
      }
    });

    $("btnLogout").addEventListener("click", async ()=>{
      try{
        await apiPost("/auth/logout");
      }catch(e){}
      await refreshMe();
    });

    $("btnExplain").addEventListener("click", doExplain);
    $("btnCopy").addEventListener("click", doCopy);
    $("btnClear").addEventListener("click", doClear);
    $("btnCalc").addEventListener("click", calcDeadline);
    $("btnToday").addEventListener("click", setToday);
    $("btnSubscribe").addEventListener("click", startCheckout);

    document.addEventListener("keydown", (e)=>{
      if((e.ctrlKey || e.metaKey) && e.key === "Enter"){
        doExplain();
      }
    });

    // init
    setToday();
    refreshMe();
  </script>
</body>
</html>
