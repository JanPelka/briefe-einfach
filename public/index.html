<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>briefe-einfach</title>
    <style>
      :root {
        --bg: #0b1220;
        --card: rgba(255, 255, 255, 0.07);
        --card2: rgba(255, 255, 255, 0.10);
        --text: #e9eefc;
        --muted: rgba(233, 238, 252, 0.65);
        --border: rgba(255, 255, 255, 0.14);
      }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
        color: var(--text);
        background:
          radial-gradient(1200px 600px at 20% 0%, rgba(77, 111, 255, 0.28), transparent 60%),
          radial-gradient(800px 500px at 90% 10%, rgba(153, 71, 255, 0.25), transparent 55%),
          var(--bg);
      }
      header {
        max-width: 1100px;
        margin: 24px auto 8px;
        padding: 0 16px;
        display: flex;
        gap: 12px;
        align-items: center;
        justify-content: space-between;
      }
      .brand {
        display: flex; gap: 10px; align-items: center;
      }
      .logo {
        width: 34px; height: 34px; border-radius: 10px;
        background: rgba(255,255,255,0.12);
        display: grid; place-items: center;
        border: 1px solid var(--border);
      }
      .subtitle { color: var(--muted); font-size: 13px; margin-top: 2px; }
      .top-right { display: flex; gap: 10px; align-items: center; }
      .pill { padding: 6px 10px; border-radius: 999px; border: 1px solid var(--border); background: rgba(255,255,255,0.06); color: var(--muted); font-size: 13px; }
      button {
        border: 1px solid var(--border);
        background: rgba(255,255,255,0.08);
        color: var(--text);
        padding: 10px 12px;
        border-radius: 12px;
        cursor: pointer;
      }
      button.primary { background: rgba(77,111,255,0.35); }
      button:disabled { opacity: 0.5; cursor: not-allowed; }

      .wrap {
        max-width: 1100px;
        margin: 10px auto 60px;
        padding: 0 16px;
        display: grid;
        grid-template-columns: 1.6fr 1fr;
        gap: 14px;
        align-items: start;
      }
      .card {
        border: 1px solid var(--border);
        background: var(--card);
        border-radius: 18px;
        padding: 14px;
        backdrop-filter: blur(10px);
      }
      .card h2 { margin: 0 0 6px; font-size: 16px; }
      .hint { color: var(--muted); font-size: 13px; margin-bottom: 10px; }
      textarea, input, select {
        width: 100%;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: rgba(0,0,0,0.2);
        color: var(--text);
        padding: 10px 12px;
        outline: none;
      }
      textarea { min-height: 160px; resize: vertical; }
      .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
      .actions { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
      .resultBox { margin-top: 10px; border-top: 1px solid var(--border); padding-top: 10px; }
      .resultItem { background: rgba(255,255,255,0.06); border: 1px solid var(--border); border-radius: 12px; padding: 10px; margin-top: 8px; }
      .muted { color: var(--muted); }

      /* Modal */
      .modalBackdrop {
        position: fixed; inset: 0;
        background: rgba(0,0,0,0.55);
        display: none;
        align-items: center;
        justify-content: center;
        padding: 18px;
        z-index: 10;
      }
      .modal {
        width: min(520px, 100%);
        background: rgba(15, 20, 35, 0.92);
        border: 1px solid var(--border);
        border-radius: 18px;
        padding: 14px;
      }
      .modal h3 { margin: 0 0 10px; }
      .error { color: #ffb4b4; margin: 10px 0 0; }
      .ok { color: #baffc6; margin: 10px 0 0; }

      @media (max-width: 900px) {
        .wrap { grid-template-columns: 1fr; }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="brand">
        <div class="logo">üìÑ</div>
        <div>
          <div style="font-weight: 700;">briefe-einfach</div>
          <div class="subtitle">Text rein ‚Üí Erkl√§rung + Fristenhilfe (MVP)</div>
        </div>
      </div>

      <div class="top-right">
        <span id="userPill" class="pill">nicht eingeloggt</span>
        <button id="loginBtn">Login / Registrieren</button>
        <button id="logoutBtn" style="display:none;">Logout</button>
      </div>
    </header>

    <main class="wrap">
      <section class="card">
        <h2>üßæ Originaltext</h2>
        <div class="hint">F√ºge einen Brief/Beh√∂rden-Text ein ‚Üí klicke ‚ÄûErkl√§ren‚Äú. (MVP ohne KI-Backend)</div>
        <textarea id="inputText" placeholder="Text hier einf√ºgen..."></textarea>

        <div class="actions">
          <button class="primary" id="explainBtn">Erkl√§ren</button>
          <button id="clearBtn">Leeren</button>
          <button id="copyBtn" disabled>Ergebnis kopieren</button>
          <button class="primary" id="subscribeBtn">Abo starten (6,99‚Ç¨/Monat)</button>
        </div>

        <div class="resultBox">
          <div class="muted">Ergebnis</div>

          <div class="resultItem">
            <div style="font-weight:600;">Kurz erkl√§rt</div>
            <div id="shortResult" class="muted">Noch kein Ergebnis.</div>
          </div>

          <div class="resultItem">
            <div style="font-weight:600;">Was du tun solltest</div>
            <div id="todoResult" class="muted">‚Äî</div>
          </div>
        </div>
      </section>

      <aside class="card">
        <h2>‚è≥ Fristenrechner (MVP)</h2>
        <div class="hint">MVP: ohne Feiertage/Sonderregeln.</div>

        <label class="muted">Eingangsdatum (Start)</label>
        <input id="startDate" placeholder="tt.mm.jjjj" />

        <div style="height:10px;"></div>

        <label class="muted">Frist in Tagen</label>
        <input id="days" type="number" value="14" />

        <div style="height:10px;"></div>

        <label class="muted">Z√§hlweise</label>
        <select id="countMode">
          <option value="next">Start am n√§chsten Tag</option>
          <option value="same">Start am gleichen Tag</option>
        </select>

        <div class="actions">
          <button class="primary" id="calcBtn">Frist berechnen</button>
          <button id="todayBtn">Heute einsetzen</button>
        </div>

        <div class="resultItem">
          <div style="font-weight:600;">Ergebnis</div>
          <div id="deadlineResult" class="muted">Noch nichts berechnet.</div>
        </div>
      </aside>
    </main>

    <!-- AUTH MODAL -->
    <div id="authBackdrop" class="modalBackdrop">
      <div class="modal">
        <h3 id="authTitle">Registrieren</h3>

        <label class="muted">E-Mail</label>
        <input id="authEmail" type="email" placeholder="name@email.de" />

        <div style="height:10px;"></div>

        <label class="muted">Passwort</label>
        <input id="authPass" type="password" placeholder="Passwort" />

        <div id="authMsg" class="error" style="display:none;"></div>

        <div class="actions" style="margin-top:12px;">
          <button class="primary" id="registerDoBtn">Registrieren</button>
          <button id="loginDoBtn">Login</button>
          <button id="closeAuthBtn">Schlie√üen</button>
        </div>
      </div>
    </div>

    <script>
      // ===== UTIL =====
      const $ = (id) => document.getElementById(id);

      function showAuth(open) {
        $("authBackdrop").style.display = open ? "flex" : "none";
        $("authMsg").style.display = "none";
        $("authMsg").textContent = "";
      }

      function setMsg(text, ok=false) {
        const el = $("authMsg");
        el.style.display = "block";
        el.className = ok ? "ok" : "error";
        el.textContent = text;
      }

      async function api(path, body) {
        const res = await fetch(path, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          credentials: "include",
          body: JSON.stringify(body || {})
        });
        const data = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(data.error || "Fehler");
        return data;
      }

      async function refreshMe() {
        const res = await fetch("/auth/me", { credentials: "include" });
        const me = await res.json();
        if (me.loggedIn) {
          $("userPill").textContent = me.email + (me.isPro ? " ‚Ä¢ PRO" : "");
          $("loginBtn").style.display = "none";
          $("logoutBtn").style.display = "inline-block";
        } else {
          $("userPill").textContent = "nicht eingeloggt";
          $("loginBtn").style.display = "inline-block";
          $("logoutBtn").style.display = "none";
        }
      }

      // ===== AUTH UI =====
      $("loginBtn").onclick = () => showAuth(true);
      $("closeAuthBtn").onclick = () => showAuth(false);

      $("registerDoBtn").onclick = async () => {
        try {
          const email = $("authEmail").value.trim();
          const password = $("authPass").value;
          await api("/auth/register", { email, password });
          setMsg("Registriert & eingeloggt ‚úÖ", true);
          await refreshMe();
          setTimeout(() => showAuth(false), 500);
        } catch (e) {
          setMsg(e.message || "Fehler");
        }
      };

      $("loginDoBtn").onclick = async () => {
        try {
          const email = $("authEmail").value.trim();
          const password = $("authPass").value;
          await api("/auth/login", { email, password });
          setMsg("Eingeloggt ‚úÖ", true);
          await refreshMe();
          setTimeout(() => showAuth(false), 500);
        } catch (e) {
          setMsg(e.message || "Fehler");
        }
      };

      $("logoutBtn").onclick = async () => {
        await api("/auth/logout", {});
        await refreshMe();
      };

      // ===== MVP "Erkl√§ren" =====
      $("explainBtn").onclick = () => {
        const t = $("inputText").value.trim();
        if (!t) {
          $("shortResult").textContent = "Bitte Text einf√ºgen.";
          $("todoResult").textContent = "‚Äî";
          $("copyBtn").disabled = true;
          return;
        }
        $("shortResult").textContent =
          "MVP: Hier kommt sp√§ter die KI-Erkl√§rung. Aktuell: Text erkannt (" + t.length + " Zeichen).";
        $("todoResult").textContent =
          "MVP: N√§chster Schritt ‚Üí KI-Backend anbinden + Pro-Features per Abo freischalten.";
        $("copyBtn").disabled = false;
      };

      $("clearBtn").onclick = () => {
        $("inputText").value = "";
        $("shortResult").textContent = "Noch kein Ergebnis.";
        $("todoResult").textContent = "‚Äî";
        $("copyBtn").disabled = true;
      };

      $("copyBtn").onclick = async () => {
        const out =
          "Kurz erkl√§rt:\n" + $("shortResult").textContent +
          "\n\nWas du tun solltest:\n" + $("todoResult").textContent;
        await navigator.clipboard.writeText(out);
        alert("Kopiert ‚úÖ");
      };

      // ===== FRISTENRECHNER =====
      function parseDEDate(s) {
        const m = /^(\d{2})\.(\d{2})\.(\d{4})$/.exec(s.trim());
        if (!m) return null;
        const d = new Date(Number(m[3]), Number(m[2]) - 1, Number(m[1]));
        return isNaN(d.getTime()) ? null : d;
      }
      function fmtDE(d) {
        const dd = String(d.getDate()).padStart(2, "0");
        const mm = String(d.getMonth() + 1).padStart(2, "0");
        const yy = d.getFullYear();
        return `${dd}.${mm}.${yy}`;
      }

      $("todayBtn").onclick = () => {
        $("startDate").value = fmtDE(new Date());
      };

      $("calcBtn").onclick = () => {
        const start = parseDEDate($("startDate").value);
        const days = Number($("days").value || 0);
        const mode = $("countMode").value;

        if (!start || !days) {
          $("deadlineResult").textContent = "Bitte Datum (tt.mm.jjjj) und Tage eingeben.";
          return;
        }

        const d = new Date(start);
        if (mode === "next") d.setDate(d.getDate() + 1);
        d.setDate(d.getDate() + days - 1);

        $("deadlineResult").textContent = "Frist endet am: " + fmtDE(d);
      };

      // ===== STRIPE SUBSCRIBE =====
      $("subscribeBtn").onclick = async () => {
        try {
          const res = await fetch("/stripe/create-checkout-session", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            credentials: "include",
            body: JSON.stringify({})
          });
          const data = await res.json().catch(() => ({}));
          if (!res.ok) {
            alert(data.error || "Stripe Fehler");
            return;
          }
          window.location.href = data.url;
        } catch (e) {
          alert("Fehler: " + (e.message || e));
        }
      };

      // INIT
      refreshMe();
      if (new URLSearchParams(location.search).get("success")) {
        alert("Zahlung erfolgreich ‚úÖ (Webhook setzt sp√§ter PRO automatisch)");
      }
      if (new URLSearchParams(location.search).get("canceled")) {
        alert("Zahlung abgebrochen.");
      }
    </script>
  </body>
</html>
