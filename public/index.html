<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>briefe-einfach</title>
  <style>
    :root{
      --bg:#0b1020;
      --card: rgba(255,255,255,.06);
      --card2: rgba(255,255,255,.10);
      --text:#e9eefc;
      --muted:#a9b3d6;
      --line: rgba(255,255,255,.10);
      --accent:#4aa3ff;
      --danger:#ff4d6d;
      --ok:#2ee59d;
      --shadow: 0 20px 60px rgba(0,0,0,.45);
      --radius: 16px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(74,163,255,.18), transparent 60%),
        radial-gradient(800px 500px at 90% 10%, rgba(46,229,157,.12), transparent 55%),
        var(--bg);
      min-height:100vh;
    }
    a{color:var(--accent);text-decoration:none}
    .wrap{max-width:1100px;margin:0 auto;padding:22px}
    .header{
      display:flex;gap:14px;align-items:center;justify-content:space-between;
      padding:14px 16px;border:1px solid var(--line);border-radius:var(--radius);
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.04));
      box-shadow: var(--shadow);
    }
    .brand{display:flex;gap:12px;align-items:center}
    .logo{
      width:42px;height:42px;border-radius:12px;background:rgba(74,163,255,.18);
      display:grid;place-items:center;border:1px solid var(--line)
    }
    .brand h1{font-size:18px;margin:0}
    .brand .sub{font-size:12px;color:var(--muted);margin-top:2px}
    .actions{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{
      border:1px solid var(--line);background:rgba(255,255,255,.06);color:var(--text);
      padding:10px 12px;border-radius:12px;cursor:pointer;
      display:inline-flex;gap:8px;align-items:center;
    }
    .btn.primary{background:rgba(74,163,255,.18);border-color:rgba(74,163,255,.35)}
    .btn.danger{background:rgba(255,77,109,.12);border-color:rgba(255,77,109,.35)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .grid{
      margin-top:16px;
      display:grid;gap:16px;
      grid-template-columns: 1.35fr .65fr;
      align-items:start;
    }
    .card{
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border-radius:var(--radius);
      padding:16px;
      box-shadow: var(--shadow);
    }
    .card h2{margin:0 0 10px 0;font-size:16px}
    label{display:block;color:var(--muted);font-size:12px;margin:10px 0 6px}
    textarea,input,select{
      width:100%;
      background:rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.14);
      color:var(--text);
      border-radius:12px;
      padding:10px 12px;
      outline:none;
    }
    textarea{min-height:170px;resize:vertical}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row .btn{flex:0 0 auto}
    .hint{margin-top:8px;color:var(--muted);font-size:12px}
    .result{
      margin-top:10px;border-top:1px solid var(--line);padding-top:12px;
      display:grid;gap:10px;
    }
    .pill{display:inline-flex;gap:8px;align-items:center;font-size:12px;color:var(--muted)}
    .box{
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.25);
      border-radius:12px;padding:12px;white-space:pre-wrap
    }
    .msg{
      margin-top:10px;border-radius:12px;padding:10px 12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.25);
    }
    .msg.err{border-color:rgba(255,77,109,.45);background:rgba(255,77,109,.10)}
    .msg.ok{border-color:rgba(46,229,157,.45);background:rgba(46,229,157,.10)}
    /* Modal */
    .modalBackdrop{
      position:fixed;inset:0;background:rgba(0,0,0,.55);
      display:none;align-items:center;justify-content:center;padding:18px;z-index:10;
    }
    .modal{
      width:min(520px, 100%);
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.04));
      border-radius:18px;
      padding:16px;
      box-shadow: var(--shadow);
    }
    .modal h3{margin:0 0 10px}
    .tabs{display:flex;gap:8px;margin:8px 0 12px}
    .tab{padding:8px 10px;border-radius:12px;border:1px solid var(--line);cursor:pointer;color:var(--muted)}
    .tab.active{background:rgba(74,163,255,.18);border-color:rgba(74,163,255,.35);color:var(--text)}
    /* Spinner */
    .spinner{
      width:16px;height:16px;border-radius:999px;border:2px solid rgba(255,255,255,.25);
      border-top-color: rgba(74,163,255,.95);
      animation: spin .8s linear infinite;
      display:none;
    }
    @keyframes spin{to{transform:rotate(360deg)}}
    /* Mobile */
    @media (max-width: 900px){
      .grid{grid-template-columns:1fr}
      textarea{min-height:150px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="header">
      <div class="brand">
        <div class="logo">üìÑ</div>
        <div>
          <h1>briefe-einfach</h1>
          <div class="sub">Text rein ‚Üí Erkl√§rung + Fristenhilfe (MVP)</div>
        </div>
      </div>
      <div class="actions">
        <div class="pill" id="userPill">üë§ nicht eingeloggt</div>
        <button class="btn primary" id="btnOpenAuth">Login / Registrieren</button>
        <button class="btn" id="btnLogout" disabled>Logout</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>üìù Originaltext</h2>
        <div class="hint">F√ºge einen Brief/Beh√∂rden-Text ein ‚Üí klicke <b>Erkl√§ren</b>. (Ctrl+Enter geht auch)</div>
        <label for="txt">Text</label>
        <textarea id="txt" placeholder="Text hier einf√ºgen..."></textarea>

        <div class="row" style="margin-top:10px">
          <button class="btn primary" id="btnExplain">
            <span class="spinner" id="spinExplain"></span>
            ‚ú® Erkl√§ren
          </button>
          <button class="btn" id="btnClear">Leeren</button>
          <button class="btn" id="btnCopy" disabled>Ergebnis kopieren</button>
        </div>

        <div id="msgBox" class="msg" style="display:none"></div>

        <div class="result" id="resultWrap">
          <div class="pill">‚úÖ Ergebnis</div>
          <div>
            <div class="pill">Kurz erkl√§rt</div>
            <div class="box" id="outKurz">Noch kein Ergebnis.</div>
          </div>
          <div>
            <div class="pill">Ausf√ºhrlich</div>
            <div class="box" id="outExplain">‚Äî</div>
          </div>
          <div>
            <div class="pill">Was du tun solltest</div>
            <div class="box" id="outTodo">‚Äî</div>
          </div>
        </div>
      </div>

      <div class="card">
        <h2>‚è≥ Fristenrechner (MVP)</h2>
        <div class="hint">MVP: ohne Feiertage/Sonderregeln.</div>

        <label for="startDate">Eingangsdatum (Start)</label>
        <input id="startDate" type="date"/>

        <label for="days">Frist in Tagen</label>
        <input id="days" type="number" value="14" min="1"/>

        <label for="mode">Z√§hlweise</label>
        <select id="mode">
          <option value="next">Start am n√§chsten Tag</option>
          <option value="same">Start am selben Tag</option>
        </select>

        <div class="row" style="margin-top:12px">
          <button class="btn primary" id="btnCalc">Frist berechnen</button>
          <button class="btn" id="btnToday">Heute einsetzen</button>
        </div>

        <div class="result">
          <div class="pill">üìå Ergebnis</div>
          <div class="box" id="fristOut">Noch nichts berechnet.</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Auth Modal -->
  <div class="modalBackdrop" id="authBackdrop">
    <div class="modal">
      <h3 id="authTitle">Login</h3>
      <div class="tabs">
        <div class="tab active" id="tabLogin">Login</div>
        <div class="tab" id="tabRegister">Registrieren</div>
      </div>

      <label>E-Mail</label>
      <input id="authEmail" type="email" placeholder="name@email.de"/>

      <label>Passwort</label>
      <input id="authPass" type="password" placeholder="mind. 6 Zeichen"/>

      <div id="authMsg" class="msg err" style="display:none"></div>

      <div class="row" style="margin-top:12px">
        <button class="btn primary" id="btnAuthDo">
          <span class="spinner" id="spinAuth"></span>
          Login
        </button>
        <button class="btn" id="btnAuthClose">Schlie√üen</button>
      </div>

      <div class="hint" style="margin-top:10px">
        Hinweis: MVP-Login ist aktuell ohne Datenbank (nur Demo). Als n√§chstes bauen wir DB + Stripe-Abo sauber ein.
      </div>
    </div>
  </div>

  <script>
    // Wichtig: NIE file:/// testen. Trotzdem: BaseURL sauber machen.
    const baseURL = (location.origin && location.origin.startsWith('http'))
      ? location.origin
      : 'http://localhost:3000';

    const els = (id) => document.getElementById(id);

    const txt = els('txt');
    const msgBox = els('msgBox');
    const outKurz = els('outKurz');
    const outExplain = els('outExplain');
    const outTodo = els('outTodo');
    const btnCopy = els('btnCopy');
    const spinExplain = els('spinExplain');

    const userPill = els('userPill');
    const btnOpenAuth = els('btnOpenAuth');
    const btnLogout = els('btnLogout');

    const authBackdrop = els('authBackdrop');
    const tabLogin = els('tabLogin');
    const tabRegister = els('tabRegister');
    const authTitle = els('authTitle');
    const authEmail = els('authEmail');
    const authPass = els('authPass');
    const btnAuthDo = els('btnAuthDo');
    const btnAuthClose = els('btnAuthClose');
    const authMsg = els('authMsg');
    const spinAuth = els('spinAuth');

    let authMode = 'login'; // login | register
    let token = localStorage.getItem('token') || '';

    function showMsg(type, text){
      msgBox.style.display = 'block';
      msgBox.className = 'msg ' + (type === 'err' ? 'err' : 'ok');
      msgBox.textContent = text;
    }
    function hideMsg(){ msgBox.style.display='none'; }

    function showAuthMsg(text){
      authMsg.style.display = 'block';
      authMsg.textContent = text;
    }
    function hideAuthMsg(){ authMsg.style.display='none'; }

    function setLoggedIn(email){
      userPill.textContent = email ? `üë§ ${email}` : 'üë§ nicht eingeloggt';
      btnLogout.disabled = !email;
    }

    async function api(path, opts = {}){
      const headers = Object.assign(
        { 'Content-Type': 'application/json' },
        opts.headers || {}
      );
      if (token) headers.Authorization = 'Bearer ' + token;

      const res = await fetch(baseURL + path, { ...opts, headers });
      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data.error || 'Unbekannter Fehler');
      return data;
    }

    // --- Explain ---
    els('btnExplain').addEventListener('click', async () => {
      hideMsg();
      const text = txt.value.trim();
      if (!text) return showMsg('err','Bitte zuerst einen Text eingeben.');

      spinExplain.style.display = 'inline-block';
      els('btnExplain').disabled = true;

      try{
        const data = await api('/erklaeren', {
          method:'POST',
          body: JSON.stringify({ text })
        });
        outKurz.textContent = data.kurz || 'OK';
        outExplain.textContent = data.erklaerung || '‚Äî';
        outTodo.textContent = data.wasTun || '‚Äî';
        btnCopy.disabled = false;
        showMsg('ok','‚úÖ Erkl√§rung erstellt.');
      }catch(e){
        showMsg('err','‚ùå ' + e.message);
      }finally{
        spinExplain.style.display = 'none';
        els('btnExplain').disabled = false;
      }
    });

    els('btnClear').addEventListener('click', () => {
      txt.value = '';
      outKurz.textContent = 'Noch kein Ergebnis.';
      outExplain.textContent = '‚Äî';
      outTodo.textContent = '‚Äî';
      btnCopy.disabled = true;
      hideMsg();
    });

    els('btnCopy').addEventListener('click', async () => {
      const all = [
        'Kurz erkl√§rt:\n' + outKurz.textContent,
        '\nAusf√ºhrlich:\n' + outExplain.textContent,
        '\nWas du tun solltest:\n' + outTodo.textContent
      ].join('\n');
      await navigator.clipboard.writeText(all);
      showMsg('ok','üìã Ergebnis kopiert.');
    });

    txt.addEventListener('keydown', (e) => {
      if (e.ctrlKey && e.key === 'Enter') els('btnExplain').click();
    });

    // --- Fristenrechner ---
    function addDays(date, days){
      const d = new Date(date);
      d.setDate(d.getDate() + days);
      return d;
    }
    function fmt(d){
      return d.toLocaleDateString('de-DE', { year:'numeric', month:'2-digit', day:'2-digit' });
    }

    els('btnToday').addEventListener('click', () => {
      const now = new Date();
      const yyyy = now.getFullYear();
      const mm = String(now.getMonth()+1).padStart(2,'0');
      const dd = String(now.getDate()).padStart(2,'0');
      els('startDate').value = `${yyyy}-${mm}-${dd}`;
    });

    els('btnCalc').addEventListener('click', () => {
      const start = els('startDate').value;
      const days = parseInt(els('days').value || '0', 10);
      const mode = els('mode').value;

      if (!start || !days) return els('fristOut').textContent = 'Bitte Datum + Tage eingeben.';

      const startDate = new Date(start + 'T00:00:00');
      const effectiveStart = (mode === 'next') ? addDays(startDate, 1) : startDate;
      const end = addDays(effectiveStart, days);

      els('fristOut').textContent =
        `Start: ${fmt(startDate)}\nZ√§hlweise: ${mode === 'next' ? 'Start am n√§chsten Tag' : 'Start am selben Tag'}\nFrist (Tage): ${days}\n‚û°Ô∏è Ende (MVP): ${fmt(end)}`;
    });

    // --- Auth Modal ---
    function openAuth(){
      authBackdrop.style.display = 'flex';
      hideAuthMsg();
      authEmail.focus();
    }
    function closeAuth(){
      authBackdrop.style.display = 'none';
      authEmail.value = '';
      authPass.value = '';
      hideAuthMsg();
    }

    function setAuthMode(mode){
      authMode = mode;
      tabLogin.classList.toggle('active', mode === 'login');
      tabRegister.classList.toggle('active', mode === 'register');
      authTitle.textContent = (mode === 'login') ? 'Login' : 'Registrieren';
      btnAuthDo.textContent = (mode === 'login') ? 'Login' : 'Registrieren';
    }

    btnOpenAuth.addEventListener('click', openAuth);
    btnAuthClose.addEventListener('click', closeAuth);
    tabLogin.addEventListener('click', () => setAuthMode('login'));
    tabRegister.addEventListener('click', () => setAuthMode('register'));

    btnAuthDo.addEventListener('click', async () => {
      hideAuthMsg();
      const email = authEmail.value.trim();
      const password = authPass.value.trim();

      if (!email || !password) return showAuthMsg('Bitte E-Mail + Passwort eingeben.');
      spinAuth.style.display = 'inline-block';
      btnAuthDo.disabled = true;

      try{
        const path = authMode === 'login' ? '/auth/login' : '/auth/register';
        const data = await api(path, {
          method:'POST',
          body: JSON.stringify({ email, password })
        });
        token = data.token;
        localStorage.setItem('token', token);
        setLoggedIn(data.user.email);
        closeAuth();
        showMsg('ok', '‚úÖ Eingeloggt.');
      }catch(e){
        showAuthMsg('‚ùå ' + e.message);
      }finally{
        spinAuth.style.display = 'none';
        btnAuthDo.disabled = false;
      }
    });

    btnLogout.addEventListener('click', () => {
      token = '';
      localStorage.removeItem('token');
      setLoggedIn('');
      showMsg('ok','Du bist ausgeloggt.');
    });

    // On load: check token
    (async () => {
      if (!token) return setLoggedIn('');
      try{
        const me = await api('/auth/me');
        setLoggedIn(me.user.email);
      }catch{
        token = '';
        localStorage.removeItem('token');
        setLoggedIn('');
      }
    })();
  </script>
</body>
</html>
