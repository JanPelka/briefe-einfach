<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Briefe einfach erkl√§rt</title>
  <style>
    :root{
      --bg:#0b1020; --card:rgba(255,255,255,.06); --border:rgba(255,255,255,.12);
      --text:#e9eefc; --muted:rgba(233,238,252,.7);
      --btn:rgba(120,160,255,.22); --btn2:rgba(120,160,255,.33);
      --danger:rgba(255,80,80,.25); --ok:rgba(80,255,160,.18);
      --shadow:0 10px 30px rgba(0,0,0,.35); --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(120,160,255,.20), transparent 60%),
        radial-gradient(800px 500px at 90% 10%, rgba(120,255,200,.15), transparent 55%),
        var(--bg);
      min-height:100vh;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:22px}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:42px;height:42px;border-radius:12px;background:linear-gradient(135deg, rgba(120,160,255,.35), rgba(120,255,200,.22));
      box-shadow:var(--shadow);display:grid;place-items:center;border:1px solid var(--border)
    }
    .title{font-size:22px;font-weight:800}
    .subtitle{color:var(--muted);font-size:13px;margin-top:2px}
    .right{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .pill{padding:8px 10px;border:1px solid var(--border);border-radius:999px;background:rgba(255,255,255,.04);color:var(--muted);font-size:13px}
    .pill.pro{background:rgba(80,255,160,.10);color:rgba(160,255,210,.95)}
    .pill.free{background:rgba(255,255,255,.04)}
    .btn{
      border:1px solid var(--border);background:var(--btn);color:var(--text);
      padding:10px 12px;border-radius:12px;cursor:pointer;transition:.15s;background:var(--btn);
      box-shadow:0 6px 18px rgba(0,0,0,.18);font-weight:700;
    }
    .btn:hover{background:var(--btn2)}
    .btn.secondary{background:rgba(255,255,255,.06)}
    .btn.danger{background:var(--danger)}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .grid{display:grid;gap:14px}
    @media(min-width:980px){.grid{grid-template-columns: 1.6fr 1fr}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--r);padding:16px;box-shadow:var(--shadow)}
    h3{margin:0 0 10px 0;font-size:16px}
    .mini{font-size:12px;color:var(--muted)}
    textarea, input, select{
      width:100%;border-radius:12px;border:1px solid var(--border);background:rgba(0,0,0,.18);
      color:var(--text);padding:10px 12px;outline:none;
    }
    textarea{min-height:180px;resize:vertical;line-height:1.35}
    pre{white-space:pre-wrap;background:rgba(0,0,0,.18);border:1px solid var(--border);border-radius:12px;padding:12px;margin:10px 0 0 0}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .paywall{margin-top:12px;padding:12px;border-radius:14px;border:1px solid var(--border);background:rgba(255,255,255,.05)}
    .paywall strong{display:block;margin-bottom:6px}
    .ok{color:rgba(160,255,210,.95)}
    .bad{color:rgba(255,170,170,.95)}
    .modalBackdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:18px;z-index:10}
    .modal{width:min(480px,100%);background:rgba(15,22,45,.96);border:1px solid var(--border);border-radius:18px;padding:16px;box-shadow:var(--shadow)}
    .line{margin:10px 0;padding:10px 12px;border-radius:12px;border:1px solid var(--border);display:none}
    .line.err{background:rgba(255,80,80,.12)}
    .line.ok{background:rgba(80,255,160,.10)}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand">
        <div class="logo">üìÑ</div>
        <div>
          <div class="title">Briefe einfach erkl√§rt</div>
          <div class="subtitle">Option B: Erkl√§ren + Antwortgenerator = PRO</div>
        </div>
      </div>
      <div class="right">
        <div id="planPill" class="pill free">FREE</div>
        <div id="userPill" class="pill">nicht eingeloggt</div>
        <button id="authBtn" class="btn secondary">Login / Registrieren</button>
        <button id="logoutBtn" class="btn danger" style="display:none;">Logout</button>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h3>üßæ Text</h3>
        <div class="mini">Text einf√ºgen ist kostenlos. ‚ÄûErkl√§ren‚Äú & ‚ÄûAntwort‚Äú sind PRO.</div>
        <div style="height:10px"></div>
        <textarea id="textInput" placeholder="Text hier einf√ºgen..."></textarea>

        <div style="height:10px"></div>
        <div class="row">
          <button id="explainBtn" class="btn">Erkl√§ren (PRO)</button>
          <button id="replyBtn" class="btn secondary">Antwort erstellen (PRO)</button>
          <button id="copyBtn" class="btn secondary">Kopieren</button>
          <span style="flex:1"></span>
          <button id="subscribeBtn" class="btn">Abo starten (6,99‚Ç¨/Monat)</button>
        </div>

        <div id="paywall" class="paywall" style="display:none;">
          <strong>üîí PRO erforderlich</strong>
          <div class="mini">
            In FREE kannst du Text einf√ºgen und vorbereiten.  
            F√ºr ‚ÄûErkl√§ren‚Äú und ‚ÄûAntwortgenerator‚Äú brauchst du PRO (6,99‚Ç¨/Monat).
          </div>
          <div style="height:10px"></div>
          <div class="row">
            <button id="paywallLoginBtn" class="btn secondary">Einloggen</button>
            <button id="paywallSubBtn" class="btn">Abo starten</button>
          </div>
        </div>

        <pre id="outBox">Noch kein Ergebnis.</pre>
        <pre id="replyBox" style="display:none;"></pre>
      </div>

      <div class="card">
        <h3>‚úÖ Status</h3>
        <div class="mini" id="statusLine">Lade Status‚Ä¶</div>

        <div style="height:12px"></div>
        <div class="mini">
          Tipp: Nach Checkout-Erfolg zeigt Stripe ‚Äûsuccess‚Äú. Danach ggf. einmal neu laden.
        </div>

        <div style="height:12px"></div>
        <div class="row">
          <button id="refreshBtn" class="btn secondary">Status aktualisieren</button>
          <button id="makeProBtn" class="btn secondary" title="Nur MVP-Test">PRO testen</button>
        </div>

        <div style="height:12px"></div>
        <div class="mini bad">
          Hinweis: Dieses MVP speichert User/PRO in RAM. F√ºr ‚Äûrichtig fertig‚Äú kommt als n√§chstes DB (Postgres).
        </div>
      </div>
    </div>
  </div>

  <!-- Auth Modal -->
  <div id="authBackdrop" class="modalBackdrop">
    <div class="modal">
      <h3 id="authTitle">Login</h3>
      <div class="mini">Du brauchst Login, damit Abo/PRO zugeordnet werden kann.</div>

      <div style="height:10px"></div>
      <label class="mini">E-Mail</label>
      <input id="authEmail" placeholder="name@mail.de" />

      <div style="height:10px"></div>
      <label class="mini">Passwort</label>
      <input id="authPass" type="password" placeholder="mind. 6 Zeichen" />

      <div id="authErr" class="line err"></div>
      <div id="authOk" class="line ok"></div>

      <div style="height:10px"></div>
      <div class="row">
        <button id="doBtn" class="btn">Login</button>
        <button id="switchBtn" class="btn secondary">Registrieren</button>
        <span style="flex:1"></span>
        <button id="closeAuthBtn" class="btn secondary">Schlie√üen</button>
      </div>
    </div>
  </div>

  <script>
    const $ = (id)=>document.getElementById(id);
    let authMode = "login"; // login|register
    let currentUser = null;
    let currentPlan = "FREE";

    function show(el){ el.style.display=""; }
    function hide(el){ el.style.display="none"; }

    function setPlan(plan){
      currentPlan = plan;
      const pill = $("planPill");
      pill.textContent = plan;
      pill.classList.toggle("pro", plan==="PRO");
      pill.classList.toggle("free", plan!=="PRO");

      // PRO-gated actions:
      const pro = plan === "PRO";
      $("explainBtn").disabled = !pro;
      $("replyBtn").disabled = !pro;

      $("paywall").style.display = pro ? "none" : "none";
    }

    async function api(path, opts={}){
      const r = await fetch(path, {
        ...opts,
        headers: { "Content-Type":"application/json", ...(opts.headers||{}) },
        credentials: "include"
      });
      let data = null;
      try { data = await r.json(); } catch(e) {}
      if(!r.ok){
        const msg = data?.error || ("HTTP " + r.status);
        throw new Error(msg);
      }
      return data;
    }

    async function refreshStatus(){
      try{
        const ent = await fetch("/api/entitlement", { credentials:"include" });
        const data = await ent.json();
        if(data.loggedIn){
          currentUser = data.user;
          $("userPill").textContent = data.user.email;
          show($("logoutBtn"));
          $("authBtn").textContent = "Account";
          setPlan(data.plan);
          $("statusLine").innerHTML = `Eingeloggt: <span class="ok">${data.user.email}</span><br>Plan: <span class="ok">${data.plan}</span>`;
        } else {
          currentUser = null;
          $("userPill").textContent = "nicht eingeloggt";
          hide($("logoutBtn"));
          $("authBtn").textContent = "Login / Registrieren";
          setPlan("FREE");
          $("statusLine").innerHTML = `Nicht eingeloggt. Plan: <span class="bad">FREE</span>`;
        }
      }catch(e){
        currentUser = null;
        setPlan("FREE");
        $("statusLine").textContent = "Status konnte nicht geladen werden: " + e.message;
      }
    }

    function openAuth(){
      $("authBackdrop").style.display="flex";
      $("authErr").style.display="none";
      $("authOk").style.display="none";
      if(authMode==="login"){
        $("authTitle").textContent="Login";
        $("doBtn").textContent="Login";
        $("switchBtn").textContent="Registrieren";
      }else{
        $("authTitle").textContent="Registrieren";
        $("doBtn").textContent="Registrieren";
        $("switchBtn").textContent="Login";
      }
    }
    function closeAuth(){ $("authBackdrop").style.display="none"; }

    async function doAuth(){
      const email = $("authEmail").value.trim();
      const password = $("authPass").value;
      if(!email || !password){
        $("authErr").textContent="Bitte E-Mail und Passwort eingeben.";
        $("authErr").style.display="block";
        return;
      }
      try{
        const path = authMode==="login" ? "/auth/login" : "/auth/register";
        await api(path, { method:"POST", body: JSON.stringify({ email, password }) });
        $("authOk").textContent = authMode==="login" ? "Eingeloggt ‚úÖ" : "Registriert ‚úÖ";
        $("authOk").style.display="block";
        $("authErr").style.display="none";
        await refreshStatus();
        setTimeout(closeAuth, 450);
      }catch(e){
        $("authErr").textContent = e.message;
        $("authErr").style.display="block";
        $("authOk").style.display="none";
      }
    }

    async function logout(){
      try{ await api("/auth/logout", { method:"POST" }); }catch(e){}
      await refreshStatus();
    }

    async function startCheckout(){
      // nur wenn eingeloggt
      try{
        await api("/auth/me");
      }catch(e){
        authMode="login";
        openAuth();
        return;
      }
      try{
        const out = await api("/stripe/create-checkout-session", { method:"POST" });
        window.location.href = out.url;
      }catch(e){
        alert("Checkout Fehler: " + e.message);
      }
    }

    function showPaywall(){
      show($("paywall"));
    }

    async function explainPro(){
      // Option B: PRO only
      if(currentPlan !== "PRO"){
        showPaywall();
        return;
      }
      const text = $("textInput").value.trim();
      if(text.length < 15){
        $("outBox").textContent = "Bitte mindestens 15 Zeichen einf√ºgen.";
        return;
      }
      $("outBox").textContent = "Erkl√§re...";
      $("replyBox").style.display="none";
      try{
        const out = await api("/api/explain-text", { method:"POST", body: JSON.stringify({ text }) });
        $("outBox").textContent = out.text || "‚Äî";
      }catch(e){
        $("outBox").textContent = "Fehler: " + e.message;
      }
    }

    async function replyPro(){
      if(currentPlan !== "PRO"){
        showPaywall();
        return;
      }
      const explanation = $("outBox").textContent.trim();
      if(!explanation || explanation==="Noch kein Ergebnis." || explanation==="Erkl√§re..."){
        $("replyBox").style.display="block";
        $("replyBox").textContent = "Bitte zuerst ‚ÄûErkl√§ren‚Äú ausf√ºhren.";
        return;
      }
      $("replyBox").style.display="block";
      $("replyBox").textContent = "Erstelle Antwort...";
      try{
        const meta = {
          sender: currentUser ? currentUser.email : "",
          recipient: "",
          subject: "Antwort auf Ihr Schreiben",
          ref: "",
          place: "",
          dateStr: new Date().toLocaleDateString("de-DE")
        };
        const out = await api("/api/generate-reply", { method:"POST", body: JSON.stringify({ explanation, meta }) });
        $("replyBox").textContent = out.text || "‚Äî";
      }catch(e){
        $("replyBox").textContent = "Fehler: " + e.message;
      }
    }

    async function copyAll(){
      const a = $("outBox").textContent.trim();
      const b = $("replyBox").style.display==="none" ? "" : $("replyBox").textContent.trim();
      const txt = b ? (a + "\n\n---\n\n" + b) : a;
      try{
        await navigator.clipboard.writeText(txt);
        alert("Kopiert ‚úÖ");
      }catch(e){
        alert("Kopieren ging nicht.");
      }
    }

    async function makeProTest(){
      // MVP nur zum testen
      try{
        await api("/admin/make-pro", { method:"POST" });
        await refreshStatus();
        alert("PRO (MVP-Test) aktiviert ‚úÖ");
      }catch(e){
        alert("Geht nur wenn eingeloggt. Fehler: " + e.message);
      }
    }

    // Wire UI
    $("authBtn").addEventListener("click", ()=>{ authMode="login"; openAuth(); });
    $("logoutBtn").addEventListener("click", logout);
    $("closeAuthBtn").addEventListener("click", closeAuth);
    $("doBtn").addEventListener("click", doAuth);
    $("switchBtn").addEventListener("click", ()=>{
      authMode = authMode==="login" ? "register" : "login";
      openAuth();
    });
    $("subscribeBtn").addEventListener("click", startCheckout);
    $("paywallSubBtn").addEventListener("click", startCheckout);
    $("paywallLoginBtn").addEventListener("click", ()=>{ authMode="login"; openAuth(); });

    $("explainBtn").addEventListener("click", explainPro);
    $("replyBtn").addEventListener("click", replyPro);
    $("copyBtn").addEventListener("click", copyAll);
    $("refreshBtn").addEventListener("click", refreshStatus);
    $("makeProBtn").addEventListener("click", makeProTest);

    $("authBackdrop").addEventListener("click", (e)=>{ if(e.target===$("authBackdrop")) closeAuth(); });

    // init
    (async function init(){
      await refreshStatus();
      const p = new URLSearchParams(location.search);
      const chk = p.get("checkout");
      if(chk==="success") alert("‚úÖ Checkout erfolgreich (Test). Bitte einmal Status aktualisieren.");
      if(chk==="cancel") alert("‚ùå Checkout abgebrochen.");
    })();
  </script>
</body>
</html>
