<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>briefe-einfach</title>
  <style>
    :root{
      --bg: #0b1220;
      --card: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.10);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.65);
      --btn: #2f7cff;
      --btn2:#1c2333;
      --danger:#ff4d4d;
      --ok:#2ee59d;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius: 16px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(47,124,255,.25), transparent 55%),
        radial-gradient(800px 500px at 90% 10%, rgba(46,229,157,.18), transparent 60%),
        radial-gradient(900px 700px at 60% 100%, rgba(255,255,255,.07), transparent 60%),
        var(--bg);
      color: var(--text);
      min-height:100vh;
    }
    .topbar{
      display:flex; align-items:center; justify-content:space-between;
      padding:18px 18px 8px;
      gap:12px;
      position:sticky; top:0;
      backdrop-filter: blur(10px);
      background: linear-gradient(to bottom, rgba(11,18,32,.85), rgba(11,18,32,.30));
      z-index: 20;
    }
    .brand{
      display:flex; align-items:center; gap:10px;
      font-weight:800;
      letter-spacing:.2px;
    }
    .logo{
      width:34px; height:34px; border-radius:10px;
      display:grid; place-items:center;
      background: rgba(47,124,255,.18);
      border: 1px solid rgba(47,124,255,.30);
    }
    .brand small{ display:block; font-weight:600; color:var(--muted); margin-top:2px; }
    .actions{ display:flex; align-items:center; gap:10px; flex-wrap:wrap; }
    .pill{
      padding:8px 12px; border-radius:999px;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.12);
      color: var(--muted);
      font-size: 13px;
      max-width: 45vw;
      overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
    }
    .btn{
      border: 0;
      border-radius: 12px;
      padding: 10px 12px;
      font-weight: 800;
      cursor: pointer;
      color: white;
      background: var(--btn);
      box-shadow: 0 10px 20px rgba(47,124,255,.25);
    }
    .btn.secondary{
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow:none;
      color: var(--text);
    }
    .btn.danger{
      background: rgba(255,77,77,.18);
      border: 1px solid rgba(255,77,77,.35);
      color: #ffd7d7;
      box-shadow:none;
    }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }

    .wrap{
      max-width: 1100px;
      margin: 0 auto;
      padding: 12px 18px 30px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.6fr 1fr;
      gap: 14px;
      align-items:start;
    }

    .card{
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card h2{
      margin:0;
      padding:14px 14px 10px;
      font-size: 15px;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .sub{
      padding: 0 14px 12px;
      color: var(--muted);
      font-size: 13px;
      line-height:1.35;
    }

    textarea{
      width:100%;
      min-height: 190px;
      resize: vertical;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: var(--text);
      border-radius: 14px;
      padding: 12px;
      outline:none;
      font-size: 14px;
      line-height:1.35;
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      padding: 12px 14px 14px;
      align-items:center;
    }

    .out{
      padding: 0 14px 14px;
      display:grid;
      gap:10px;
    }

    .box{
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.14);
      padding: 12px;
    }
    .box h3{ margin:0 0 6px; font-size: 13px; color: rgba(255,255,255,.85); }
    .box p{ margin:0; color: var(--muted); font-size: 13px; line-height:1.35; }

    .rightCard .row{
      padding-top: 0;
    }

    .field{
      display:grid; gap:6px;
      padding: 0 14px 14px;
    }
    .field label{
      color: var(--muted);
      font-size: 12px;
    }
    input, select{
      width:100%;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 10px;
      outline:none;
      font-size: 14px;
    }

    .hint{
      color: var(--muted);
      font-size: 12px;
      padding: 0 14px 14px;
    }

    /* Mobile */
    @media (max-width: 900px){
      .grid{ grid-template-columns: 1fr; }
      .pill{ max-width: 60vw; }
    }

    /* Modal Auth */
    .modalBackdrop{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      display: none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 50;
    }
    .modal{
      width: min(420px, 100%);
      background: rgba(15,22,40,.92);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      box-shadow: 0 20px 60px rgba(0,0,0,.55);
      overflow:hidden;
    }
    .modalHeader{
      padding: 14px 14px 8px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .modalHeader h3{ margin:0; font-size: 16px; }
    .modalBody{ padding: 0 14px 14px; display:grid; gap:10px; }
    .modalMsg{
      border-radius: 12px;
      padding: 10px 10px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      color: var(--muted);
      font-size: 13px;
    }
    .modalMsg.error{
      border-color: rgba(255,77,77,.35);
      background: rgba(255,77,77,.12);
      color: #ffd7d7;
    }
    .modalFooter{
      padding: 12px 14px 14px;
      display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;
    }
    .link{
      color: rgba(47,124,255,.95);
      cursor:pointer;
      font-weight: 800;
      text-decoration:none;
    }
    .smallLine{
      padding: 0 14px 14px;
      color: var(--muted);
      font-size: 13px;
    }

    /* Loader */
    .spinner{
      width:16px; height:16px;
      border-radius:50%;
      border: 2px solid rgba(255,255,255,.25);
      border-top-color: rgba(255,255,255,.9);
      display:inline-block;
      animation: spin .8s linear infinite;
      vertical-align: -3px;
      margin-right:8px;
    }
    @keyframes spin{ to { transform: rotate(360deg); } }
  </style>
</head>
<body>

  <div class="topbar">
    <div class="brand">
      <div class="logo">üìÑ</div>
      <div>
        briefe-einfach
        <small>Text rein ‚Üí Erkl√§rung + Fristenhilfe (MVP)</small>
      </div>
    </div>

    <div class="actions">
      <div class="pill" id="userPill">nicht eingeloggt</div>
      <button class="btn secondary" id="authBtn">Login / Registrieren</button>
      <button class="btn danger" id="logoutBtn" style="display:none;">Logout</button>
    </div>
  </div>

  <div class="wrap">
    <div class="grid">

      <!-- LEFT: Text + Ergebnis -->
      <div class="card">
        <h2>üßæ Originaltext</h2>
        <div class="sub">F√ºge einen Brief/Beh√∂rden-Text ein ‚Üí klicke <b>Erkl√§ren</b>. (Ctrl+Enter geht auch)</div>

        <div style="padding:0 14px 14px;">
          <textarea id="inputText" placeholder="Text hier einf√ºgen..."></textarea>
        </div>

        <div class="row">
          <button class="btn" id="explainBtn">‚ú® Erkl√§ren</button>
          <button class="btn secondary" id="clearBtn">Leeren</button>
          <button class="btn secondary" id="copyBtn" disabled>Ergebnis kopieren</button>
          <span id="statusLine" style="color:var(--muted); font-size:13px;"></span>
        </div>

        <div class="out">
          <div class="box">
            <h3>‚úÖ Ergebnis</h3>
            <p id="resultShort">Noch kein Ergebnis.</p>
          </div>
          <div class="box">
            <h3>üß† Ausf√ºhrlich</h3>
            <p id="resultLong">‚Äî</p>
          </div>
          <div class="box">
            <h3>üõ†Ô∏è Was du tun solltest</h3>
            <p id="resultTodo">‚Äî</p>
          </div>
        </div>
      </div>

      <!-- RIGHT: Frist + Abo -->
      <div class="card rightCard">
        <h2>‚è≥ Fristenrechner (MVP)</h2>
        <div class="sub">MVP: ohne Feiertage/Sonderregeln.</div>

        <div class="field">
          <label for="startDate">Eingangsdatum (Start)</label>
          <input id="startDate" type="date" />
        </div>

        <div class="field">
          <label for="days">Frist in Tagen</label>
          <input id="days" type="number" value="14" min="1" max="365" />
        </div>

        <div class="field">
          <label for="countMode">Z√§hlweise</label>
          <select id="countMode">
            <option value="nextDay" selected>Start am n√§chsten Tag</option>
            <option value="sameDay">Start am selben Tag</option>
          </select>
        </div>

        <div class="row">
          <button class="btn" id="calcBtn">Frist berechnen</button>
          <button class="btn secondary" id="todayBtn">Heute einsetzen</button>
        </div>

        <div class="out">
          <div class="box">
            <h3>üìå Ergebnis</h3>
            <p id="deadlineOut">Noch nichts berechnet.</p>
          </div>
        </div>

        <hr style="border:0;border-top:1px solid rgba(255,255,255,.10); margin:0 0 12px;" />

        <h2>‚≠ê Pro (Abo)</h2>
        <div class="sub">
          Pro schaltet zus√§tzliche Funktionen frei (z.B. bessere Formatierung, mehr Erkl√§rung, sp√§ter: Upload, Speicherung etc.).
        </div>

        <div class="row">
          <button class="btn" id="subscribeBtn">Abo starten (6,99‚Ç¨/Monat)</button>
        </div>

        <div class="hint">
          Hinweis: F√ºr Checkout brauchst du Login (Email). Stripe √∂ffnet dann die sichere Bezahlseite.
        </div>
      </div>

    </div>
  </div>

  <!-- AUTH MODAL -->
  <div class="modalBackdrop" id="authBackdrop">
    <div class="modal">
      <div class="modalHeader">
        <h3 id="authTitle">Registrieren</h3>
        <button class="btn secondary" id="closeAuth">‚úï</button>
      </div>

      <div class="modalBody">
        <div class="field" style="padding:0;">
          <label for="authEmail">E-Mail</label>
          <input id="authEmail" type="email" placeholder="name@mail.de" />
        </div>

        <div class="field" style="padding:0;">
          <label for="authPass">Passwort</label>
          <input id="authPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        </div>

        <div class="modalMsg" id="authMsg">Bitte registrieren oder einloggen.</div>

        <div class="row" style="padding:0;">
          <button class="btn" id="doRegister">Registrieren</button>
          <button class="btn secondary" id="doLogin">Login</button>
        </div>

        <div class="smallLine">
          Schon ein Konto? <span class="link" id="switchToLogin">Login</span>
          &nbsp;&nbsp;|&nbsp;&nbsp;
          Neu hier? <span class="link" id="switchToRegister">Registrieren</span>
        </div>
      </div>
    </div>
  </div>

<script>
  // ====== Simple local auth (MVP) ======
  // Speichert User nur im Browser. Sp√§ter ersetzen wir das durch richtiges Backend + DB.
  const state = {
    userEmail: localStorage.getItem("be_userEmail") || "",
  };

  const userPill = document.getElementById("userPill");
  const authBtn = document.getElementById("authBtn");
  const logoutBtn = document.getElementById("logoutBtn");

  function renderAuth(){
    if(state.userEmail){
      userPill.textContent = state.userEmail;
      authBtn.style.display = "none";
      logoutBtn.style.display = "inline-block";
    } else {
      userPill.textContent = "nicht eingeloggt";
      authBtn.style.display = "inline-block";
      logoutBtn.style.display = "none";
    }
  }

  function setUser(email){
    state.userEmail = email || "";
    if(state.userEmail){
      localStorage.setItem("be_userEmail", state.userEmail);
    } else {
      localStorage.removeItem("be_userEmail");
    }
    renderAuth();
  }

  // Modal logic
  const authBackdrop = document.getElementById("authBackdrop");
  const authTitle = document.getElementById("authTitle");
  const authMsg = document.getElementById("authMsg");
  const authEmail = document.getElementById("authEmail");
  const authPass = document.getElementById("authPass");
  const closeAuth = document.getElementById("closeAuth");
  const doRegister = document.getElementById("doRegister");
  const doLogin = document.getElementById("doLogin");
  const switchToLogin = document.getElementById("switchToLogin");
  const switchToRegister = document.getElementById("switchToRegister");

  function openAuth(mode="register"){
    authBackdrop.style.display = "flex";
    setAuthMode(mode);
    authEmail.value = state.userEmail || "";
    authPass.value = "";
    setMsg("Bitte registrieren oder einloggen.", false);
  }
  function closeAuthModal(){
    authBackdrop.style.display = "none";
  }
  function setAuthMode(mode){
    if(mode === "login"){
      authTitle.textContent = "Login";
    } else {
      authTitle.textContent = "Registrieren";
    }
  }
  function setMsg(text, isError){
    authMsg.textContent = text;
    authMsg.classList.toggle("error", !!isError);
  }

  authBtn.addEventListener("click", () => openAuth("register"));
  closeAuth.addEventListener("click", closeAuthModal);
  authBackdrop.addEventListener("click", (e) => { if(e.target === authBackdrop) closeAuthModal(); });

  switchToLogin.addEventListener("click", () => setAuthMode("login"));
  switchToRegister.addEventListener("click", () => setAuthMode("register"));

  doRegister.addEventListener("click", () => {
    const email = (authEmail.value || "").trim();
    const pass = (authPass.value || "").trim();
    if(!email || !pass) return setMsg("Bitte E-Mail und Passwort eingeben.", true);
    // MVP: wir speichern nur Email lokal
    setUser(email);
    setMsg("Registriert (MVP). Du bist jetzt eingeloggt.", false);
    setTimeout(closeAuthModal, 500);
  });

  doLogin.addEventListener("click", () => {
    const email = (authEmail.value || "").trim();
    const pass = (authPass.value || "").trim();
    if(!email || !pass) return setMsg("Bitte E-Mail und Passwort eingeben.", true);
    setUser(email);
    setMsg("Login ok (MVP).", false);
    setTimeout(closeAuthModal, 500);
  });

  logoutBtn.addEventListener("click", () => {
    setUser("");
  });

  // ====== Explain button (MVP - placeholder) ======
  const explainBtn = document.getElementById("explainBtn");
  const clearBtn = document.getElementById("clearBtn");
  const copyBtn = document.getElementById("copyBtn");
  const inputText = document.getElementById("inputText");
  const statusLine = document.getElementById("statusLine");
  const resultShort = document.getElementById("resultShort");
  const resultLong = document.getElementById("resultLong");
  const resultTodo = document.getElementById("resultTodo");

  function setStatus(text){ statusLine.textContent = text || ""; }

  function setResult(shortText, longText, todoText){
    resultShort.textContent = shortText || "‚Äî";
    resultLong.textContent = longText || "‚Äî";
    resultTodo.textContent = todoText || "‚Äî";
    copyBtn.disabled = !shortText;
  }

  explainBtn.addEventListener("click", async () => {
    const t = (inputText.value || "").trim();
    if(!t){
      setStatus("Bitte zuerst einen Text eingeben.");
      return;
    }
    setStatus("Erkl√§re... (MVP)");
    // Placeholder. Sp√§ter h√§ngt hier die echte KI.
    setTimeout(() => {
      setResult(
        "Das ist eine einfache Erkl√§rung: Der Brief richtet sich an dich und du sollst reagieren.",
        "Ausf√ºhrlicher: Hier kommt sp√§ter die KI-Erkl√§rung. Aktuell ist das ein MVP-Platzhalter.",
        "Was du tun solltest: Frist pr√ºfen, Antwort vorbereiten, Unterlagen sammeln."
      );
      setStatus("");
    }, 400);
  });

  clearBtn.addEventListener("click", () => {
    inputText.value = "";
    setResult("Noch kein Ergebnis.", "‚Äî", "‚Äî");
    setStatus("");
    copyBtn.disabled = true;
  });

  copyBtn.addEventListener("click", async () => {
    const all = [
      "Kurz erkl√§rt: " + resultShort.textContent,
      "Ausf√ºhrlich: " + resultLong.textContent,
      "Was du tun solltest: " + resultTodo.textContent
    ].join("\n\n");
    await navigator.clipboard.writeText(all);
    setStatus("‚úÖ Ergebnis kopiert");
    setTimeout(() => setStatus(""), 800);
  });

  inputText.addEventListener("keydown", (e) => {
    if(e.ctrlKey && e.key === "Enter"){
      explainBtn.click();
    }
  });

  // ====== Deadline calc ======
  const startDate = document.getElementById("startDate");
  const days = document.getElementById("days");
  const countMode = document.getElementById("countMode");
  const calcBtn = document.getElementById("calcBtn");
  const todayBtn = document.getElementById("todayBtn");
  const deadlineOut = document.getElementById("deadlineOut");

  function formatDE(d){
    const dd = String(d.getDate()).padStart(2,"0");
    const mm = String(d.getMonth()+1).padStart(2,"0");
    const yyyy = d.getFullYear();
    return `${dd}.${mm}.${yyyy}`;
  }

  function calcDeadline(){
    if(!startDate.value){
      deadlineOut.textContent = "Bitte Startdatum ausw√§hlen.";
      return;
    }
    const n = Math.max(1, parseInt(days.value || "14", 10));
    const base = new Date(startDate.value + "T00:00:00");
    const start = new Date(base);

    if(countMode.value === "nextDay"){
      start.setDate(start.getDate() + 1);
    }

    const end = new Date(start);
    end.setDate(end.getDate() + (n - 1));

    deadlineOut.textContent = `Fristende: ${formatDE(end)} (Start: ${formatDE(start)}, ${n} Tage)`;
  }

  calcBtn.addEventListener("click", calcDeadline);
  todayBtn.addEventListener("click", () => {
    const now = new Date();
    const yyyy = now.getFullYear();
    const mm = String(now.getMonth()+1).padStart(2,"0");
    const dd = String(now.getDate()).padStart(2,"0");
    startDate.value = `${yyyy}-${mm}-${dd}`;
    calcDeadline();
  });

  // ====== Stripe subscribe ======
  const subscribeBtn = document.getElementById("subscribeBtn");

  function setSubscribeLoading(isLoading){
    subscribeBtn.disabled = isLoading;
    subscribeBtn.innerHTML = isLoading ? `<span class="spinner"></span>Weiter zu Stripe...` : `Abo starten (6,99‚Ç¨/Monat)`;
  }

  subscribeBtn.addEventListener("click", async () => {
    if(!state.userEmail){
      openAuth("register");
      setMsg("Bitte erst einloggen/registrieren, damit Stripe deine E-Mail bekommt.", false);
      return;
    }
    try{
      setSubscribeLoading(true);

      const r = await fetch("/create-checkout-session", {
        method: "POST",
        headers: { "Content-Type":"application/json" },
        body: JSON.stringify({ email: state.userEmail })
      });

      if(!r.ok){
        const txt = await r.text();
        throw new Error(txt || "Serverfehler");
      }

      const data = await r.json();
      if(!data.url) throw new Error("Keine Checkout-URL erhalten.");

      window.location.href = data.url;
    } catch(err){
      console.error(err);
      alert("Abo konnte nicht gestartet werden: " + (err.message || err));
    } finally{
      setSubscribeLoading(false);
    }
  });

  // Init
  renderAuth();
  setResult("Noch kein Ergebnis.", "‚Äî", "‚Äî");
</script>

</body>
</html>
