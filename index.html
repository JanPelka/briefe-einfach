<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>briefe-einfach</title>

  <style>
    :root { color-scheme: light dark; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin: 0; padding: 24px;
      max-width: 980px;
      margin-inline: auto;
    }
    h1 { margin: 0 0 6px 0; }
    p { margin: 0 0 16px 0; opacity: 0.85; }
    textarea {
      width: 100%;
      min-height: 220px;
      resize: vertical;
      padding: 14px;
      border-radius: 12px;
      border: 1px solid rgba(127,127,127,0.35);
      font-size: 16px;
      line-height: 1.35;
      outline: none;
      box-sizing: border-box;
    }
    .row {
      display: flex;
      gap: 12px;
      align-items: center;
      margin: 12px 0 6px;
      flex-wrap: wrap;
    }
    button {
      border: 0;
      border-radius: 12px;
      padding: 12px 16px;
      font-size: 15px;
      cursor: pointer;
    }
    button.primary { font-weight: 700; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .status {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(127,127,127,0.25);
      font-size: 14px;
      display: none;
      white-space: pre-wrap;
      overflow-wrap: anywhere;
    }
    .status.ok { display: block; }
    .status.err { display: block; }
    .output {
      margin-top: 14px;
      padding: 14px;
      border-radius: 12px;
      border: 1px solid rgba(127,127,127,0.35);
      min-height: 120px;
      white-space: pre-wrap;
      overflow-wrap: anywhere;
    }
    .meta {
      margin-top: 10px;
      font-size: 13px;
      opacity: 0.7;
    }
    .small {
      font-size: 12px;
      opacity: 0.7;
    }
    .hint {
      margin-top: 8px;
      font-size: 12px;
      opacity: 0.75;
    }
  </style>
</head>

<body>
  <h1>ðŸ§¾ briefe-einfach</h1>
  <p>FÃ¼ge einen Brief/BehÃ¶rden-Text ein â†’ klicke <b>ErklÃ¤ren</b> â†’ du bekommst eine einfache ErklÃ¤rung.</p>

  <label for="input" class="small">Originaltext</label>
  <textarea id="input" placeholder="Text hier einfÃ¼gen..."></textarea>

  <div class="row">
    <button id="btnExplain" class="primary">âœ¨ ErklÃ¤ren</button>
    <button id="btnClear" type="button">ðŸ§¹ Leeren</button>
    <button id="btnCopy" type="button" disabled>ðŸ“‹ Ergebnis kopieren</button>
  </div>

  <div id="status" class="status"></div>

  <div class="meta">
    <div><b>Ergebnis</b></div>
    <div id="output" class="output"></div>
    <div class="hint">Tipp: Wenn du das spÃ¤ter Ã¶ffentlich nutzt, bauen wir als NÃ¤chstes Rate-Limit + API-Key Schutz + bessere Formatierung ein.</div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    const input = $("input");
    const output = $("output");
    const statusBox = $("status");

    const btnExplain = $("btnExplain");
    const btnClear = $("btnClear");
    const btnCopy = $("btnCopy");

    function setStatus(type, msg) {
      statusBox.className = "status " + (type || "");
      statusBox.textContent = msg || "";
      statusBox.style.display = msg ? "block" : "none";
    }

    function setLoading(isLoading) {
      btnExplain.disabled = isLoading;
      btnExplain.textContent = isLoading ? "â³ Bitte warten..." : "âœ¨ ErklÃ¤ren";
    }

    function normalizeApiResult(data) {
      // Du hast aktuell in der Konsole sowas gesehen wie:
      // ok explanation
      // True  ðŸ§¾ Einfache ErklÃ¤rung (MVP): ...
      //
      // Da wir nicht 100% wissen, wie dein server.js die JSON Keys nennt,
      // fangen wir mehrere mÃ¶gliche Felder ab.
      if (!data || typeof data !== "object") return "";

      return (
        data.explanation ??
        data.result ??
        data.output ??
        data.text ??
        data.message ??
        (typeof data === "string" ? data : "")
      );
    }

    async function explain() {
      const text = input.value.trim();
      if (!text) {
        setStatus("err", "Bitte erst Text einfÃ¼gen.");
        return;
      }

      setStatus("", "");
      setLoading(true);
      output.textContent = "";

      try {
        const res = await fetch("/erklaeren", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ text })
        });

        let data;
        const ct = res.headers.get("content-type") || "";
        if (ct.includes("application/json")) {
          data = await res.json();
        } else {
          data = { text: await res.text() };
        }

        if (!res.ok) {
          const errMsg = (data && (data.error || data.message)) ? (data.error || data.message) : "Unbekannter Fehler";
          throw new Error(errMsg);
        }

        const result = normalizeApiResult(data) || JSON.stringify(data, null, 2);

        output.textContent = result;
        btnCopy.disabled = !result;

        setStatus("ok", "âœ… ErklÃ¤rung erstellt.");
      } catch (e) {
        setStatus("err", "âŒ Fehler: " + (e?.message || e));
      } finally {
        setLoading(false);
      }
    }

    btnExplain.addEventListener("click", explain);

    btnClear.addEventListener("click", () => {
      input.value = "";
      output.textContent = "";
      btnCopy.disabled = true;
      setStatus("", "");
      input.focus();
    });

    btnCopy.addEventListener("click", async () => {
      const text = output.textContent.trim();
      if (!text) return;
      try {
        await navigator.clipboard.writeText(text);
        setStatus("ok", "âœ… Ergebnis kopiert.");
        setTimeout(() => setStatus("", ""), 1200);
      } catch {
        setStatus("err", "âŒ Kopieren ging nicht (Browser-Rechte). Markiere den Text manuell und kopiere ihn.");
      }
    });

    // Optional: CTRL+ENTER zum Senden
    input.addEventListener("keydown", (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === "Enter") explain();
    });
  </script>
</body>
</html>
